# =============================================================================
# Fahras — Development Docker Compose
# =============================================================================
# Zero-config development environment. Just run:
#
#   docker compose -f docker-compose.dev.yml up -d
#
# No .env file required — all defaults are baked in.
#
# Access Points:
#   Frontend:       http://localhost:3000
#   API (via Nginx): http://localhost/api
#   API (direct):   http://localhost:80/api
#   PostgreSQL:     localhost:5433
#   Redis:          localhost:6379
#   MinIO Console:  http://localhost:9001  (minioadmin / minioadmin123)
#
# Default Credentials:
#   Admin:   admin@fahras.edu / password
#   Faculty: sarah.johnson@fahras.edu / password
#   Student: ahmed.almansouri@student.fahras.edu / password
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Nginx — Reverse proxy (API + Frontend + MinIO)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:latest
    container_name: fahras-dev-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./.docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./api/public:/var/www/html/public:ro
    depends_on:
      php:
        condition: service_healthy
      laravel-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - fahras-dev

  # ---------------------------------------------------------------------------
  # PHP-FPM — Laravel 11 API
  # ---------------------------------------------------------------------------
  php:
    build:
      context: .
      dockerfile: .docker/api/Dockerfile
    container_name: fahras-dev-php
    restart: unless-stopped
    volumes:
      - ./api:/var/www/html
      - ./api/php-custom.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - php_storage:/var/www/html/storage
    environment:
      # --- App ---
      APP_NAME: "Fahras API"
      APP_ENV: local
      APP_DEBUG: "true"
      APP_KEY: "base64:dGhpc2lzYWRldmVsb3BtZW50a2V5MTIzNDU2Nzg="
      APP_URL: "http://localhost"
      APP_TIMEZONE: "Asia/Riyadh"
      FRONTEND_URL: "http://localhost:3000"

      # --- Database ---
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: "5432"
      DB_DATABASE: fahras
      DB_USERNAME: fahras
      DB_PASSWORD: fahras_password

      # --- Redis ---
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_CLIENT: predis
      CACHE_STORE: redis
      QUEUE_CONNECTION: sync
      SESSION_DRIVER: redis

      # --- MinIO (S3-compatible storage) ---
      FILESYSTEM_DISK: s3
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin123
      AWS_DEFAULT_REGION: us-east-1
      AWS_BUCKET: fahras-files
      AWS_ENDPOINT: "http://minio:9000"
      AWS_URL: "http://localhost:9000"
      AWS_USE_PATH_STYLE_ENDPOINT: "true"

      # --- Sanctum ---
      SANCTUM_STATEFUL_DOMAINS: "localhost,localhost:3000,127.0.0.1,127.0.0.1:3000"

      # --- Logging (dev-friendly) ---
      LOG_CHANNEL: stack
      LOG_LEVEL: debug

      # --- UTF-8 Support ---
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

      # --- PHP ---
      PHP_MEMORY_LIMIT: 512M
      PHP_UPLOAD_MAX_FILESIZE: 100M
      PHP_POST_MAX_SIZE: 100M
      PHP_MAX_EXECUTION_TIME: "300"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - fahras-dev

  # ---------------------------------------------------------------------------
  # PostgreSQL 16
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    container_name: fahras-dev-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: fahras
      POSTGRES_USER: fahras
      POSTGRES_PASSWORD: fahras_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fahras -d fahras || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - fahras-dev
    shm_size: 256mb

  # ---------------------------------------------------------------------------
  # Redis 7
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: fahras-dev-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - fahras-dev

  # ---------------------------------------------------------------------------
  # Node — React 19 + Vite dev server (HMR)
  # ---------------------------------------------------------------------------
  node:
    image: node:20-alpine
    container_name: fahras-dev-node
    restart: unless-stopped
    volumes:
      - ./web:/app
      - node_modules:/app/node_modules
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      VITE_API_URL: /api
      VITE_APP_NAME: Fahras
      CI: "false"
    command: sh -c "npm install --no-audit --prefer-offline && npm start"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000 || exit 0"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s
    networks:
      - fahras-dev

  # ---------------------------------------------------------------------------
  # MinIO — S3-compatible object storage
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: fahras-dev-minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_BROWSER_REDIRECT_URL: "http://localhost:9001"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - fahras-dev

  # ---------------------------------------------------------------------------
  # MinIO Init — Create default bucket
  # ---------------------------------------------------------------------------
  minio-init:
    image: minio/mc:latest
    container_name: fahras-dev-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Configuring MinIO...';
      mc alias set myminio http://minio:9000 minioadmin minioadmin123;
      mc mb myminio/fahras-files --ignore-existing;
      mc anonymous set download myminio/fahras-files;
      echo 'MinIO configured successfully!';
      exit 0;
      "
    networks:
      - fahras-dev
    restart: "no"

  # ---------------------------------------------------------------------------
  # Laravel Init — Migrations + Seeding (runs once)
  # ---------------------------------------------------------------------------
  laravel-init:
    build:
      context: .
      dockerfile: .docker/api/Dockerfile
    container_name: fahras-dev-laravel-init
    volumes:
      - ./api:/var/www/html
      - php_storage:/var/www/html/storage
    environment:
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: "5432"
      DB_DATABASE: fahras
      DB_USERNAME: fahras
      DB_PASSWORD: fahras_password
      APP_ENV: local
      APP_DEBUG: "true"
      APP_KEY: "base64:dGhpc2lzYWRldmVsb3BtZW50a2V5MTIzNDU2Nzg="
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      REDIS_CLIENT: predis
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo '=== Fahras Dev — Laravel Init ===';

      chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache 2>/dev/null || true;
      chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache 2>/dev/null || true;

      echo 'Waiting for database...';
      sleep 5;

      echo 'Running migrations...';
      php artisan migrate --force || echo 'Migrations already run or failed';

      echo 'Seeding database...';
      php artisan db:seed --force || echo 'Seeders already run or failed';

      echo 'Clearing caches...';
      php artisan config:clear || true;
      php artisan cache:clear || true;
      php artisan route:clear || true;
      php artisan view:clear || true;

      echo 'Creating storage link...';
      php artisan storage:link --force 2>/dev/null || true;

      echo '=== Dev environment ready! ===';
      exit 0;
      "
    networks:
      - fahras-dev
    restart: "no"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  node_modules:
    driver: local
  php_storage:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  fahras-dev:
    driver: bridge
