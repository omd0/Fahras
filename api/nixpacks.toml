# =============================================================================
# Fahras API — NixPacks Configuration
# Laravel 11 · PHP 8.3 · PostgreSQL 16 · Redis 7
# =============================================================================
#
# Deploy on Railway, Render, Coolify, or any NixPacks-compatible PaaS.
#
# Required environment variables (set in your platform dashboard):
#   APP_KEY            — Laravel encryption key (base64:...)
#   APP_URL            — Public URL of the API (https://api.example.com)
#   DB_CONNECTION      — pgsql
#   DB_HOST            — PostgreSQL host
#   DB_PORT            — PostgreSQL port (default: 5432)
#   DB_DATABASE        — Database name
#   DB_USERNAME        — Database user
#   DB_PASSWORD        — Database password
#   REDIS_HOST         — Redis host
#   REDIS_PORT         — Redis port (default: 6379)
#   FILESYSTEM_DISK    — s3 (for S3/MinIO) or local
#   AWS_ACCESS_KEY_ID  — S3 access key (if using s3 disk)
#   AWS_SECRET_ACCESS_KEY — S3 secret key
#   AWS_DEFAULT_REGION — S3 region
#   AWS_BUCKET         — S3 bucket name
#   AWS_ENDPOINT       — S3 endpoint (for MinIO or custom S3)
#   AWS_URL            — Public S3 URL
#   AWS_USE_PATH_STYLE_ENDPOINT — true (for MinIO)
#
# Optional:
#   PORT               — Server listen port (default: 8080)
#   LOG_CHANNEL        — stderr (recommended for PaaS)
#   CACHE_DRIVER       — redis
#   QUEUE_CONNECTION   — redis
#   SESSION_DRIVER     — redis
# =============================================================================

providers = ["php"]

# ---------------------------------------------------------------------------
# Build-time environment
# ---------------------------------------------------------------------------
[variables]
APP_ENV       = "production"
APP_DEBUG     = "false"
LOG_CHANNEL   = "stderr"
NIXPACKS_PHP_ROOT_DIR = "/app"

# ---------------------------------------------------------------------------
# Phase: setup — system packages & PHP extensions
# ---------------------------------------------------------------------------
[phases.setup]
nixPkgs = [
    # PHP runtime + Composer
    "php83",
    "php83Packages.composer",

    # Database
    "php83Extensions.pdo_pgsql",
    "php83Extensions.pgsql",
    "postgresql",

    # Cache / Queue
    "php83Extensions.redis",

    # Laravel required
    "php83Extensions.mbstring",
    "php83Extensions.xml",
    "php83Extensions.dom",
    "php83Extensions.curl",
    "php83Extensions.fileinfo",
    "php83Extensions.tokenizer",
    "php83Extensions.ctype",
    "php83Extensions.openssl",
    "php83Extensions.bcmath",
    "php83Extensions.pcntl",
    "php83Extensions.intl",

    # Image processing (GD)
    "php83Extensions.gd",
    "php83Extensions.exif",
]
aptPkgs = [
    "libpq-dev",
    "libpng-dev",
    "libjpeg-dev",
    "libfreetype6-dev",
    "libonig-dev",
    "libxml2-dev",
    "zip",
    "unzip",
    "locales",
]

# ---------------------------------------------------------------------------
# Phase: install — Composer dependencies
# ---------------------------------------------------------------------------
[phases.install]
dependsOn = ["setup"]
cmds = [
    "composer install --no-dev --optimize-autoloader --no-interaction --no-scripts",
    "php artisan package:discover --ansi || true",
]
cacheDirectories = ["vendor"]

# ---------------------------------------------------------------------------
# Phase: build — Laravel optimisation caches
# ---------------------------------------------------------------------------
[phases.build]
dependsOn = ["install"]
cmds = [
    "mkdir -p storage/framework/{cache,sessions,views}",
    "mkdir -p storage/logs",
    "mkdir -p bootstrap/cache",
    "chmod -R 775 storage bootstrap/cache",
    "php artisan config:cache  || true",
    "php artisan route:cache   || true",
    "php artisan view:cache    || true",
    "php artisan event:cache   || true",
]

# ---------------------------------------------------------------------------
# Start command
# ---------------------------------------------------------------------------
# Uses Laravel's built-in server — suitable for PaaS (Railway, Render, etc.)
# The platform provides PORT via environment; falls back to 8080.
#
# For higher throughput consider Laravel Octane:
#   cmd = "php artisan octane:start --server=frankenphp --host=0.0.0.0 --port=${PORT:-8080}"
# ---------------------------------------------------------------------------
[start]
cmd = "php artisan migrate --force && php artisan serve --host=0.0.0.0 --port=${PORT:-8080}"
